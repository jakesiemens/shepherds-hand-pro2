<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shepherd's Hand Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }
        .animate-enter { animation: enter 0.3s ease-out; }
        .animate-leave { animation: leave 0.2s ease-in forwards; }
        @keyframes enter {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes leave {
            from { opacity: 1; transform: scale(1) translateY(0); }
            to { opacity: 0; transform: scale(0.95) translateY(10px); }
        }
        .pulse-red { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            object-fit: cover;
            background-color: #e2e8f0;
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.125rem;
            flex-shrink: 0;
        }
        .avatar-sm { width: 40px; height: 40px; font-size: 1rem; }
        .avatar-lg { width: 80px; height: 80px; font-size: 2rem; }
        .nav-btn.active { background-color: #e0f2fe; color: #0284c7; }
        .tab-btn {
            padding: 8px 12px;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 9999px;
            background-color: transparent;
            color: #475569;
            transition: all 0.2s ease-in-out;
        }
        .tab-btn.active {
            background-color: #0284c7;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .person-detail-input {
            border: 2px dashed #cbd5e1;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .person-detail-textarea {
            border: 2px dashed #cbd5e1;
            padding: 4px 8px;
            border-radius: 6px;
            width: 100%;
            font-size: 0.875rem;
            color: #475569;
        }
        .person-tab-btn {
            flex: 1;
            padding: 10px 0;
            font-weight: 600;
            color: #64748b;
            border-bottom: 2px solid transparent;
            text-align: center;
        }
        .person-tab-btn.active {
            color: #0284c7;
            border-bottom-color: #0284c7;
        }
        .gemini-output {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .gemini-output-card {
            position: relative;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: #f1f5f9;
            color: #475569;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .gemini-output-card:hover .copy-btn {
            opacity: 1;
        }
        .copy-btn:active {
            background-color: #e2e8f0;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased">

    <div id="app" class="h-full w-full flex flex-col overflow-hidden max-w-lg mx-auto bg-slate-100 shadow-2xl">

        <!-- Main App Screen -->
        <div id="main-app" class="h-full w-full flex flex-col">
            <header class="bg-white/80 backdrop-blur-lg shadow-sm p-4 flex justify-between items-center z-20 border-b border-slate-200">
                <div class="flex items-center gap-3">
                    <i class="fas fa-praying-hands text-2xl text-sky-600"></i>
                    <h1 class="text-xl font-bold text-slate-800">Shepherd's Hand</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button id="backup-btn" class="text-slate-500 hover:text-sky-600 font-medium text-sm flex items-center gap-2 py-2 px-3 bg-slate-100 rounded-lg" title="Backup Data">
                        <i class="fas fa-download"></i> <span class="hidden sm:inline">Backup</span>
                    </button>
                    <button id="restore-btn" class="text-slate-500 hover:text-sky-600 font-medium text-sm flex items-center gap-2 py-2 px-3 bg-slate-100 rounded-lg" title="Restore Data">
                        <i class="fas fa-upload"></i> <span class="hidden sm:inline">Restore</span>
                    </button>
                    <input type="file" id="restore-input" class="hidden" accept=".json">
                    
                    <button id="settings-btn" class="text-slate-500 hover:text-sky-600 font-medium text-sm flex items-center justify-center w-10 h-10 bg-slate-100 rounded-full" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </header>

            <main id="main-content" class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-100/50">
                <div id="app-loading" class="flex flex-col items-center justify-center h-full text-slate-500">
                    <i class="fas fa-spinner animate-spin text-3xl"></i>
                    <p class="mt-4">Loading your ministry...</p>
                </div>
            </main>

            <nav class="bg-white/80 backdrop-blur-lg shadow-[0_-2px_5px_rgba(0,0,0,0.05)] grid grid-cols-5 gap-1 p-2 z-40 border-t border-slate-200">
                <button data-view="dashboard" class="nav-btn flex flex-col items-center justify-center p-2 rounded-lg"><i class="fas fa-home text-lg"></i><span class="text-xs font-medium mt-1">Home</span></button>
                <button data-view="people" class="nav-btn flex flex-col items-center justify-center p-2 rounded-lg"><i class="fas fa-users text-lg"></i><span class="text-xs font-medium mt-1">People</span></button>
                <button data-view="overdue" class="nav-btn flex flex-col items-center justify-center p-2 rounded-lg"><i class="fas fa-bullhorn text-lg"></i><span class="text-xs font-medium mt-1">Overdue</span></button>
                <button data-view="hospitality" class="nav-btn flex flex-col items-center justify-center p-2 rounded-lg"><i class="fas fa-utensils text-lg"></i><span class="text-xs font-medium mt-1">Hospitality</span></button>
                <button data-view="resources" class="nav-btn flex flex-col items-center justify-center p-2 rounded-lg"><i class="fas fa-book-open text-lg"></i><span class="text-xs font-medium mt-1">Resources</span></button>
            </nav>
        </div>
    </div>

    <!-- Modal Shell -->
    <div id="modal-container" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden max-w-lg mx-auto">
        <div id="modal-content" class="bg-white w-full max-w-md rounded-2xl shadow-2xl animate-enter"></div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-24 right-4 bg-slate-800 text-white py-2 px-5 rounded-full shadow-lg opacity-0 translate-y-4 transition-all duration-300 z-50 hidden">
        <p id="toast-message"></p>
    </div>

    <!-- Firebase SDK (DUMMY for API) -->
    <script type="module">
        // --- CONSTANTS & CONFIG ---
        const API_KEY = ""; // Leave blank
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const DEFAULT_PULSE = 30;

        // --- STATE ---
        const state = { 
            people: [], tasks: [], updates: [], milestones: [], hospitality: [], prayerRequests: [],
            currentView: 'dashboard',
            selectedPerson: null,
            dataLoaded: false,
            settings: { myHousehold: null, lastBackup: null },
            peopleSubView: 'all', // 'all' or 'households'
            overdueSubView: 'all', // 'all' or 'missed'
            hospitalitySubView: 'upcoming', // 'upcoming' or 'past'
            spiritualGifts: ["Administration", "Apostleship", "Craftsmanship", "Creative Communication", "Discernment", "Encouragement", "Evangelism", "Faith", "Giving", "Healing", "Helps", "Hospitality", "Intercession", "Knowledge", "Leadership", "Mercy", "Miracles", "Prophecy", "Shepherding", "Teaching", "Wisdom"],
            churchRoles: ["Greeter", "Usher", "Small Group Leader", "Children's Ministry", "Youth Group Leader", "Worship Team (Vocal)", "Worship Team (Instrument)", "Tech Team (Sound/Slides)", "Visitation Team", "Meal Train Coordinator", "Building Maintenance", "Event Planning Committee"]
        };

        // --- UI ELEMENTS ---
        const ui = {
            mainApp: document.getElementById('main-app'),
            mainContent: document.getElementById('main-content'),
            navButtons: document.querySelectorAll('.nav-btn'),
            modalContainer: document.getElementById('modal-container'),
            modalContent: document.getElementById('modal-content'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            appLoading: document.getElementById('app-loading'),
            backupBtn: document.getElementById('backup-btn'),
            restoreBtn: document.getElementById('restore-btn'),
            restoreInput: document.getElementById('restore-input'),
            settingsBtn: document.getElementById('settings-btn'),
        };

        // --- UTILS ---
        const utils = {
            formatDate(timestamp, options = {}) { 
                if (!timestamp) return 'N/A'; 
                const date = new Date(timestamp);
                return date.toLocaleDateString('en-US', { timeZone: 'UTC', month: 'short', day: 'numeric', year: 'numeric', ...options }); 
            },
            formatRelativeTime(timestamp) {
                if (!timestamp) return ''; 
                const date = new Date(timestamp);
                const now = new Date(); 
                const seconds = Math.floor((now - date) / 1000); 
                let interval = seconds / 31536000; if (interval > 1) return `${Math.floor(interval)}y ago`; 
                interval = seconds / 2592000; if (interval > 1) return `${Math.floor(interval)}mo ago`; 
                interval = seconds / 86400; if (interval > 1) return `${Math.floor(interval)}d ago`; 
                interval = seconds / 3600; if (interval > 1) return `${Math.floor(interval)}h ago`; 
                interval = seconds / 60; if (interval > 1) return `${Math.floor(interval)}m ago`; 
                return 'Just now'; 
            },
            showToast(message) {
                ui.toastMessage.textContent = message;
                ui.toast.classList.remove('hidden', 'opacity-0', 'translate-y-4');
                setTimeout(() => {
                    ui.toast.classList.add('opacity-0', 'translate-y-4');
                    setTimeout(() => ui.toast.classList.add('hidden'), 300);
                }, 3000);
            },
            getIconForUpdateType(type) { const icons = { 'Meeting': 'fa-solid fa-coffee', 'Phone Call': 'fa-solid fa-phone', 'Hospital Visit': 'fa-solid fa-hospital', 'Home Visit': 'fa-solid fa-house-user', 'Prayer': 'fa-solid fa-person-praying', 'Counseling': 'fa-solid fa-hand-holding-heart', 'General Note': 'fa-solid fa-note-sticky', 'WhatsApp Chat': 'fab fa-whatsapp', 'Hospitality': 'fa-solid fa-utensils' }; return icons[type] || 'fa-solid fa-circle-info'; },
            getIconForMilestoneType(type) { const icons = { 'Birthday': 'fa-solid fa-birthday-cake', 'Anniversary': 'fa-solid fa-heart', 'Baptism': 'fa-solid fa-water', 'Joined Church': 'fa-solid fa-church', 'Loss of Loved One': 'fa-solid fa-cross', }; return icons[type] || 'fa-solid fa-star'; },
            formatPhoneNumberForWhatsApp(phone) { if (!phone) return ''; return phone.replace(/\D/g, ''); },
            generateInitials(name) { if (!name) return '?'; const names = name.split(' '); const initials = names.map(n => n[0]).join(''); return initials.slice(0, 2).toUpperCase(); },
            getAvatar(person, classes = 'avatar-sm') { if (person.photoURL) { return `<img src="${person.photoURL}" class="avatar ${classes}" alt="${person.name}">`; } else { return `<div class="avatar bg-sky-200 text-sky-700 ${classes}">${utils.generateInitials(person.name)}</div>`; } },
            getHouseholds() {
                const households = {};
                state.people.forEach(p => {
                    if (p.family === state.settings.myHousehold) return; // Exclude my household
                    const key = p.family || p.name;
                    if (!households[key]) { households[key] = { name: key, members: [] }; }
                    households[key].members.push(p);
                });
                return Object.values(households).sort((a, b) => a.name.localeCompare(b.name));
            },
            getLastContact(personId) {
                return state.updates.filter(u => u.personId === personId).sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())[0];
            },
            getDaysSinceLastContact(personId) {
                const lastUpdate = utils.getLastContact(personId);
                if (!lastUpdate) return Infinity;
                return (new Date() - new Date(lastUpdate.createdAt)) / (1000 * 60 * 60 * 24);
            },
            getPersonPulseStatus(person) {
                const days = utils.getDaysSinceLastContact(person.id);
                const pulse = person.pulse || DEFAULT_PULSE;
                if (days > pulse) return 'overdue'; // red
                if (days <= pulse) return 'recent'; // green
                return 'unknown';
            },
            getPeopleToContact() {
                return state.people
                    .filter(p => p.family !== state.settings.myHousehold)
                    .map(p => ({ ...p, daysSinceContact: utils.getDaysSinceLastContact(p.id) }))
                    .filter(p => p.daysSinceContact > (p.pulse || DEFAULT_PULSE))
                    .sort((a, b) => b.daysSinceContact - a.daysSinceContact);
            },
            getSuggestedContact() {
                const overdue = utils.getPeopleToContact();
                return overdue[0] || null; // The most overdue person
            },
            getUpcomingMilestones() {
                const now = new Date();
                const todayDay = now.getDate();
                const todayMonth = now.getMonth();
                const in30Days = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

                return state.milestones
                    .filter(m => (m.type === 'Birthday' || m.type === 'Anniversary') && m.family !== state.settings.myHousehold)
                    .map(m => ({ ...m, date: new Date(m.date) }))
                    .map(m => {
                        const mDate = m.date.getDate();
                        const mMonth = m.date.getMonth();
                        
                        // Check if it already happened this year
                        const nextOccurrence = new Date(now.getFullYear(), mMonth, mDate);
                        if (nextOccurrence < now) {
                            nextOccurrence.setFullYear(now.getFullYear() + 1); // Check next year
                        }
                        return { ...m, nextOccurrence, daysAway: (nextOccurrence - now) / (1000 * 60 * 60 * 24) };
                    })
                    .filter(m => m.daysAway <= 30 && m.daysAway >= 0)
                    .sort((a, b) => a.daysAway - b.daysAway);
            },
            getSundaySupperSuggestion() {
                // Get all households, excluding my own
                const households = utils.getHouseholds();
                if (households.length === 0) return [];
            
                // Find last hospitality event (hosted OR guest) for each household
                const householdsWithLastEvent = households.map(h => {
                    const lastEvent = state.hospitality
                        .filter(event => {
                            const isHost = event.type === 'guest' && event.host_family === h.name;
                            const isAttendee = event.type === 'host' && (event.attendee_families || []).includes(h.name);
                            return isHost || isAttendee;
                        })
                        .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())[0];
                    
                    return { ...h, lastEventDate: lastEvent ? new Date(lastEvent.date) : null };
                });

                // Sort by last event date (nulls first, then oldest to newest)
                householdsWithLastEvent.sort((a, b) => {
                    if (!a.lastEventDate && !b.lastEventDate) return 0; // both null
                    if (!a.lastEventDate) return -1; // a is null, comes first
                    if (!b.lastEventDate) return 1; // b is null, comes first
                    return a.lastEventDate.getTime() - b.lastEventDate.getTime();
                });

                // Return the two households we've seen least recently
                return householdsWithLastEvent.slice(0, 2);
            },
            blobToDataURL(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            },
            fallbackCopyText(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                
                // Avoid scrolling to bottom
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.position = "fixed";

                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    document.execCommand('copy');
                    utils.showToast('Copied to clipboard!');
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    utils.showToast('Could not copy text.');
                }

                document.body.removeChild(textArea);
            },
            async callGeminiApi(systemPrompt, userPrompt) {
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error('Gemini API Error Response:', errorBody);
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0] && result.candidates[0].content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else if (result.candidates && result.candidates[0] && result.candidates[0].finishReason === 'SAFETY') {
                        throw new Error("Response blocked by safety filter.");
                    } else {
                        console.warn('Invalid response structure:', result);
                        throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error('Gemini API call failed:', error);
                    throw error;
                }
            }
        };

        // --- DATABASE (localStorage) ---
        const db = {
            init() {
                const data = localStorage.getItem('shepherdsHandPro');
                if (data) {
                    const parsedData = JSON.parse(data);
                    Object.assign(state, parsedData);
                } else {
                    // First time load, seed sample data
                    this.seedSampleData();
                }
                state.dataLoaded = true;
                appController.refreshCurrentView();
            },
            save() {
                const dataToSave = {
                    people: state.people,
                    tasks: state.tasks,
                    updates: state.updates,
                    milestones: state.milestones,
                    hospitality: state.hospitality,
                    prayerRequests: state.prayerRequests,
                    settings: state.settings
                };
                localStorage.setItem('shepherdsHandPro', JSON.stringify(dataToSave));
            },
            backup() {
                const data = localStorage.getItem('shepherdsHandPro');
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'shepherds-hand-backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                state.settings.lastBackup = new Date().toISOString();
                this.save();
                utils.showToast('Backup downloaded!');
                appController.refreshCurrentView(); // Refresh to hide reminder
            },
            restore(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.people && data.tasks && data.updates) {
                            localStorage.setItem('shepherdsHandPro', JSON.stringify(data));
                            Object.assign(state, data); // Load new data into state
                            state.dataLoaded = true;
                            appController.refreshCurrentView(); // Re-render all
                            utils.showToast('Data restored successfully!');
                        } else {
                            utils.showToast('Invalid backup file.');
                        }
                    } catch (error) {
                        utils.showToast('Could not read backup file.');
                    }
                };
                reader.readAsText(file);
            },
            seedSampleData() {
                const today = new Date();
                const personData = [
                    { id: crypto.randomUUID(), name: "John Smith", family: "Smith Family", phone: "15551234567", email: "john.smith@example.com", gifts: ["Teaching"], roles: ["Small Group Leader"], pulse: 30, keyInfo: "Leads the Tuesday night small group. Passionate about apologetics.", createdAt: new Date().toISOString() },
                    { id: crypto.randomUUID(), name: "Jane Smith", family: "Smith Family", phone: "15551234568", email: "jane.smith@example.com", gifts: ["Hospitality"], roles: ["Meal Train Coordinator"], pulse: 30, keyInfo: "Coordinates meals for new parents and those in need.", createdAt: new Date().toISOString() },
                    { id: crypto.randomUUID(), name: "David Miller", family: "Miller Family", phone: "15552345678", email: "david.miller@example.com", gifts: ["Helps"], roles: ["Usher"], pulse: 45, keyInfo: "Faithful usher. Works in construction.", createdAt: new Date().toISOString() },
                    { id: crypto.randomUUID(), name: "Maria Garcia", family: "Garcia Family", phone: "15553456789", email: "maria.garcia@example.com", gifts: ["Encouragement"], roles: [], pulse: 30, keyInfo: "Newer to the church. Looking to get connected.", createdAt: new Date().toISOString() },
                ];
                
                const updatesData = [
                    { id: crypto.randomUUID(), personId: personData[1].id, type: "Meeting", notes: "Met for coffee to discuss the meal train ministry. She has some great ideas.", createdAt: new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString() },
                    { id: crypto.randomUUID(), personId: personData[2].id, type: "Phone Call", notes: "Checked in with David. He's doing well.", createdAt: new Date(today.getTime() - 40 * 24 * 60 * 60 * 1000).toISOString() }, // Needs contact
                ];
                
                const tasksData = [
                    { id: crypto.randomUUID(), personId: personData[0].id, description: "Call John about small group curriculum", dueDate: new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000).toISOString(), completed: false, createdAt: new Date().toISOString() }
                ];

                const milestonesData = [
                    { id: crypto.randomUUID(), personId: personData[0].id, type: "Birthday", date: new Date('1985-10-15T00:00:00').toISOString(), createdAt: new Date().toISOString() }
                ];

                const hospitalityData = [
                    { id: crypto.randomUUID(), type: "host", date: new Date(today.getTime() - 12 * 24 * 60 * 60 * 1000).toISOString(), attendee_families: ["Smith Family", "Garcia Family"], journal: "Great time together after service. The kids played well.", createdAt: new Date().toISOString() }
                ];
                
                const prayerData = [
                    { id: crypto.randomUUID(), personId: personData[3].id, request: "Prayer for upcoming job interview on Wednesday.", status: 'Active', createdAt: new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString() }
                ];
                
                state.people = personData;
                state.updates = updatesData;
                state.tasks = tasksData;
                state.milestones = milestonesData;
                state.hospitality = hospitalityData;
                state.prayerRequests = prayerData;
                state.settings = { myHousehold: null, lastBackup: null };

                this.save();
                utils.showToast('Sample ministry data loaded!');
            }
        };

        // --- MODAL SERVICE ---
        const modalService = {
            open(content, size = 'md') {
                const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl' };
                ui.modalContent.className = `bg-white w-full rounded-2xl shadow-2xl animate-enter ${sizeClasses[size] || 'max-w-md'}`;
                ui.modalContent.innerHTML = content;
                ui.modalContainer.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            },
            close() {
                if (ui.modalContainer.classList.contains('hidden')) return;
                
                // Find active textareas and blur them to hide mobile keyboard
                const activeTextareas = ui.modalContent.querySelectorAll('textarea:focus, input:focus');
                activeTextareas.forEach(el => el.blur());

                ui.modalContent.classList.remove('animate-enter');
                ui.modalContent.classList.add('animate-leave');
                ui.modalContainer.classList.add('animate-leave');

                const onAnimationEnd = () => {
                    ui.modalContainer.classList.add('hidden');
                    ui.modalContent.classList.remove('animate-leave');
                    ui.modalContainer.classList.remove('animate-leave');
                    ui.modalContent.innerHTML = '';
                    document.body.style.overflow = 'auto';
                    ui.modalContainer.removeEventListener('animationend', onAnimationEnd);
                };
                ui.modalContainer.addEventListener('animationend', onAnimationEnd);
            }
        };

        // --- RENDER FUNCTIONS ---
        const render = {
            dashboard() {
                if (!state.dataLoaded) return;
                ui.appLoading.classList.add('hidden');
                
                const suggestedContact = utils.getSuggestedContact();
                const upcomingMilestones = utils.getUpcomingMilestones();
                const supperSuggestions = utils.getSundaySupperSuggestion();

                let backupReminder = '';
                if (!state.settings.lastBackup) {
                    backupReminder = `<div id="backup-reminder" class="bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 rounded-lg mb-6">
                        <h4 class="font-bold">Welcome!</h4>
                        <p class="text-sm">Don't forget to make your first backup. Go to <i class="fas fa-cog"></i> Settings to backup your data.</p>
                    </div>`;
                } else {
                    const daysSinceBackup = (new Date() - new Date(state.settings.lastBackup)) / (1000 * 60 * 60 * 24);
                    if (daysSinceBackup > 7) {
                         backupReminder = `<div id="backup-reminder" class="bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 rounded-lg mb-6">
                            <h4 class="font-bold">Backup Recommended</h4>
                            <p class="text-sm">It's been ${Math.floor(daysSinceBackup)} days since your last backup. Click the <i class="fas fa-download"></i> icon to save your data.</p>
                        </div>`;
                    }
                }

                let suggestedContactCard = `<div class="bg-white p-6 rounded-2xl shadow-sm text-center">
                    <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                    <h4 class="font-semibold text-slate-800">All Caught Up!</h4>
                    <p class="text-slate-500 text-sm mt-1">Everyone has been contacted recently. Great work!</p>
                </div>`;

                if (suggestedContact) {
                    const hasWhatsApp = suggestedContact.phone && suggestedContact.phone.length > 5;
                    suggestedContactCard = `<div class="bg-white p-6 rounded-2xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-slate-700">Today's Suggested Contact</h3>
                            <button id="get-conversation-starters" data-person-id="${suggestedContact.id}" class="text-sky-600 hover:text-sky-800" title="Get AI Conversation Starters">
                                <i class="fas fa-comment-dots text-xl"></i>
                            </button>
                        </div>
                        <div id="conversation-starters-output" class="hidden mb-4 p-3 bg-sky-50 rounded-lg text-sm text-sky-800"></div>
                        
                        <div class="flex items-center gap-4 mb-4">
                            ${utils.getAvatar(suggestedContact, 'avatar-lg')}
                            <div>
                                <p class="text-2xl font-bold text-slate-800">${suggestedContact.name}</p>
                                <p class="text-slate-500">Last contact: ${utils.formatRelativeTime(utils.getLastContact(suggestedContact.id)?.createdAt)}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            ${hasWhatsApp ? `<a href="https://wa.me/${utils.formatPhoneNumberForWhatsApp(suggestedContact.phone)}" target="_blank" class="flex items-center justify-center gap-2 bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 transition">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>` : ''}
                            <button data-person-id="${suggestedContact.id}" class="log-contact-btn flex items-center justify-center gap-2 bg-sky-600 text-white font-semibold py-3 rounded-lg hover:bg-sky-700 transition ${hasWhatsApp ? 'col-span-1' : 'col-span-2'}">
                                <i class="fas fa-edit"></i> Log Contact
                            </button>
                        </div>
                        <button data-person-id="${suggestedContact.id}" class="view-person-btn w-full text-center text-sm font-medium text-slate-500 hover:text-sky-600 mt-4">
                            View Profile &rarr;
                        </button>
                    </div>`;
                }

                ui.mainContent.innerHTML = `<div class="animate-enter space-y-6">
                    ${backupReminder}
                    ${suggestedContactCard}
                    
                    <div>
                        <h3 class="text-lg font-semibold text-slate-700 mb-3 px-2">Sunday Supper Suggestions</h3>
                        ${supperSuggestions.length > 0 ? `
                            <div class="bg-white rounded-2xl shadow-sm p-4 space-y-3">
                                ${supperSuggestions.map(h => `
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            ${utils.getAvatar({name: h.name}, 'avatar-sm')}
                                            <div>
                                                <p class="font-medium text-slate-800">${h.name}</p>
                                                <p class="text-sm text-slate-500">${h.members.length} members</p>
                                            </div>
                                        </div>
                                        <button class="log-hospitality-btn bg-sky-100 text-sky-700 text-xs font-bold px-3 py-1 rounded-full" data-families="${h.name}">INVITE</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="bg-white rounded-2xl shadow-sm p-4 text-center text-slate-500 text-sm">
                                <p>No suggestions right now. Host a new family!</p>
                            </div>
                        `}
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-slate-700 mb-3 px-2">Upcoming Milestones (30 Days)</h3>
                        <div class="bg-white rounded-2xl shadow-sm p-4 space-y-3">
                            ${upcomingMilestones.length > 0 ? upcomingMilestones.map(m => {
                                const p = state.people.find(person => person.id === m.personId);
                                if (!p) return '';
                                return `<div class="flex items-center gap-3">
                                    <div class="bg-yellow-100 text-yellow-600 h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-full"><i class="${utils.getIconForMilestoneType(m.type)}"></i></div>
                                    <div>
                                        <p class="font-medium text-slate-800">${p.name}</p>
                                        <p class="text-sm text-slate-500">${m.type} on ${utils.formatDate(m.nextOccurrence, {month: 'short', day: 'numeric'})}</p>
                                    </div>
                                </div>`
                            }).join('') : '<p class="text-center text-slate-500 py-4">No upcoming milestones.</p>'}
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <button id="quick-add-update" class="bg-sky-100 text-sky-700 p-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-2"><i class="fas fa-plus"></i> Update</button>
                        <button id="quick-add-task" class="bg-green-100 text-green-700 p-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-2"><i class="fas fa-check"></i> Task</button>
                        <button id="quick-add-person" class="bg-indigo-100 text-indigo-700 p-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-2"><i class="fas fa-user-plus"></i> Person</button>
                    </div>
                </div>`;
            },
            peopleList() {
                if (!state.dataLoaded) return;
                ui.appLoading.classList.add('hidden');
                
                const renderAllPeople = () => {
                    const searchTerm = document.getElementById('people-search')?.value.toLowerCase() || '';
                    const filteredPeople = state.people
                        .filter(p => p.name.toLowerCase().includes(searchTerm) && p.family !== state.settings.myHousehold)
                        .sort((a, b) => a.name.localeCompare(b.name));
                    
                    return `<div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <ul id="people-list-container" class="divide-y divide-slate-200">
                            ${filteredPeople.length > 0 ? filteredPeople.map(p => {
                                const pulseStatus = utils.getPersonPulseStatus(p);
                                const pulseClass = pulseStatus === 'overdue' ? 'bg-red-500' : (pulseStatus === 'recent' ? 'bg-green-500' : 'bg-slate-300');
                                
                                return `<li data-person-id="${p.id}" class="person-item p-3 hover:bg-slate-50 cursor-pointer transition">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            ${utils.getAvatar(p)}
                                            <div>
                                                <p class="font-semibold text-slate-800">${p.name}</p>
                                                <p class="text-sm text-slate-500">${p.family || 'No household'}</p>
                                            </div>
                                        </div>
                                        <div classf="flex items-center gap-3">
                                            <span class="w-3 h-3 ${pulseClass} rounded-full mr-3" title="Contact Status"></span>
                                            <i class="fas fa-chevron-right text-slate-400"></i>
                                        </div>
                                    </div>
                                </li>`
                            }).join('') : `<li class="p-8 text-center text-slate-500"><i class="fas fa-users text-4xl text-slate-300 mb-3"></i><p>No people found.</p></li>`}
                        </ul>
                    </div>`;
                };

                const renderHouseholds = () => {
                    const households = utils.getHouseholds();
                    return `<div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <ul id="household-list-container" class="divide-y divide-slate-200">
                            ${households.length > 0 ? households.map(h => `
                                <li class="p-4">
                                    <p class="font-semibold text-slate-800 mb-3">${h.name}</p>
                                    <div class="flex flex-wrap gap-4">
                                        ${h.members.map(p => `
                                            <div data-person-id="${p.id}" class="person-item flex flex-col items-center cursor-pointer w-20">
                                                ${utils.getAvatar(p)}
                                                <p class="text-xs font-medium text-center mt-1 truncate w-full">${p.name.split(' ')[0]}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </li>
                            `).join('') : `<li class="p-8 text-center text-slate-500"><p>No households found.</p></li>`}
                        </ul>
                    </div>`;
                };

                const content = state.peopleSubView === 'all' ? renderAllPeople() : renderHouseholds();

                ui.mainContent.innerHTML = `<div class="animate-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-slate-800">Congregation</h2>
                        <div class="flex items-center gap-2">
                            <button id="import-contacts-btn" class="bg-green-600 text-white w-10 h-10 flex items-center justify-center rounded-full shadow-lg hover:bg-green-700 transition flex-shrink-0" title="Import from Device Contacts">
                                <i class="fas fa-address-book"></i>
                            </button>
                            <button id="add-person-btn" class="bg-sky-600 text-white w-10 h-10 flex items-center justify-center rounded-full shadow-lg hover:bg-sky-700 transition flex-shrink-0" title="Add New Person">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-4 p-1 bg-slate-200 rounded-full">
                        <button class="tab-btn flex-1 ${state.peopleSubView === 'all' ? 'active' : ''}" data-subview="all">All People</button>
                        <button class="tab-btn flex-1 ${state.peopleSubView === 'households' ? 'active' : ''}" data-subview="households">Households</button>
                    </div>
                    ${state.peopleSubView === 'all' ? `
                        <div class="relative mb-4">
                            <input type="search" id="people-search" placeholder="Search by name..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-full focus:ring-2 focus:ring-sky-500">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        </div>
                    ` : ''}
                    <div id="people-list-content">
                        ${content}
                    </div>
                </div>`;
                
                // Re-attach listener for search input if it exists
                const searchInput = document.getElementById('people-search');
                if (searchInput) {
                    searchInput.addEventListener('input', e => {
                        document.getElementById('people-list-content').innerHTML = renderAllPeople();
                    });
                }
            },
            personDetail(personId) {
                if (!state.dataLoaded) return;
                const person = state.people.find(p => p.id === personId);
                if (!person) { render.peopleList(); return; }
                state.selectedPerson = person;

                const householdMembers = person.family ? state.people.filter(p => p.family === person.family && p.id !== person.id) : [];

                const personUpdates = state.updates.filter(u => u.personId === personId).sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
                const personTasks = state.tasks.filter(t => t.personId === personId).sort((a, b) => (a.completed - b.completed) || new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
                const personMilestones = state.milestones.filter(m => m.personId === personId).sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime());
                const personPrayerReqs = state.prayerRequests.filter(pr => pr.personId === personId).sort((a,b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

                ui.mainContent.innerHTML = `<div class="animate-enter">
                    <button id="back-to-people" class="text-slate-500 hover:text-sky-600 mb-4 -ml-1 flex items-center gap-2 font-medium"><i class="fas fa-arrow-left text-lg"></i> Back to People</button>
                    
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <div class="flex items-start gap-4">
                            ${utils.getAvatar(person, 'avatar-lg')}
                            <div class="flex-1">
                                <input type="text" id="person-detail-name" value="${person.name}" class="text-3xl font-bold text-slate-800 w-full bg-transparent person-detail-input mb-1">
                                <input type="text" id="person-detail-family" value="${person.family || ''}" placeholder="Household Name" class="text-slate-500 w-full bg-transparent person-detail-input">
                            </div>
                            <button id="delete-person-btn" data-person-id="${person.id}" class="text-red-500 hover:text-red-700 w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full bg-red-50" title="Delete Person">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        ${householdMembers.length > 0 ? `
                            <div class="mt-6">
                                <label class="block text-sm font-medium text-slate-500 mb-2">In Household</label>
                                <div class="flex flex-wrap gap-4">
                                    ${householdMembers.map(p => `
                                        <div data-person-id="${p.id}" class="person-item flex flex-col items-center cursor-pointer w-20">
                                            ${utils.getAvatar(p)}
                                            <p class="text-xs font-medium text-center mt-1 truncate w-full">${p.name}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="mt-6">
                             <label class="block text-sm font-medium text-slate-500 mb-1">Pastoral Concerns / Key Info</label>
                             <textarea id="person-detail-keyinfo" class="person-detail-textarea" rows="3" placeholder="e.g., Struggling with assurance, Job searching...">${person.keyInfo || ''}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-500">Phone</label>
                                <input type="tel" id="person-detail-phone" value="${person.phone || ''}" class="w-full person-detail-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-500">Email</label>
                                <input type="email" id="person-detail-email" value="${person.email || ''}" class="w-full person-detail-input">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-500 mt-4">Contact Pulse (days)</label>
                            <input type="number" id="person-detail-pulse" value="${person.pulse || DEFAULT_PULSE}" class="w-full person-detail-input">
                        </div>
                        <button id="save-person-details-btn" class="w-full bg-sky-600 text-white font-semibold py-2.5 rounded-lg hover:bg-sky-700 transition text-sm mt-6">
                            Save Changes
                        </button>
                    </div>

                    <div class="grid grid-cols-4 gap-2 mb-6">
                        <button data-person-id="${person.id}" class="add-update-btn bg-white p-3 rounded-xl shadow-sm text-center font-medium text-slate-700 hover:bg-slate-50 transition flex flex-col items-center gap-1">
                            <i class="fas fa-plus-circle text-sky-500"></i><span class="text-xs">Update</span>
                        </button>
                        <button data-person-id="${person.id}" class="add-task-btn bg-white p-3 rounded-xl shadow-sm text-center font-medium text-slate-700 hover:bg-slate-50 transition flex flex-col items-center gap-1">
                            <i class="fas fa-clipboard-check text-green-500"></i><span class="text-xs">Task</span>
                        </button>
                        <button data-person-id="${person.id}" class="add-milestone-btn bg-white p-3 rounded-xl shadow-sm text-center font-medium text-slate-700 hover:bg-slate-50 transition flex flex-col items-center gap-1">
                            <i class="fas fa-star text-yellow-500"></i><span class="text-xs">Milestone</span>
                        </button>
                        <button data-person-id="${person.id}" class="log-hospitality-btn bg-white p-3 rounded-xl shadow-sm text-center font-medium text-slate-700 hover:bg-slate-50 transition flex flex-col items-center gap-1" data-families="${person.family || person.name}">
                            <i class="fas fa-utensils text-amber-500"></i><span class="text-xs">Hospitality</span>
                        </button>
                    </div>

                    <div class="flex border-b border-slate-200 mb-4">
                        <button class="person-tab-btn active" data-tab="updates">Updates</button>
                        <button class="person-tab-btn" data-tab="tasks">Tasks</button>
                        <button class="person-tab-btn" data-tab="milestones">Milestones</button>
                        <button class="person-tab-btn" data-tab="prayer">Prayer</button>
                        <button class="person-tab-btn" data-tab="calling">Calling</button>
                    </div>

                    <div id="person-tab-content" class="space-y-4">
                        <div id="updates-content" class="tab-pane">
                            ${personUpdates.length > 0 ? personUpdates.map(u => `
                                <div class="bg-white p-4 rounded-xl shadow-sm">
                                    <div class="flex items-start gap-4">
                                        <div class="bg-slate-100 text-slate-500 h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-full">
                                            <i class="${utils.getIconForUpdateType(u.type)}"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex justify-between items-baseline">
                                                <p class="font-semibold text-slate-700">${u.type}</p>
                                                <p class="text-xs text-slate-400">${utils.formatDate(u.createdAt)}</p>
                                            </div>
                                            <p class="text-slate-600 mt-1 whitespace-pre-wrap">${u.notes}</p>
                                        </div>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-2 pt-2 border-t border-slate-100">
                                        <button data-update-id="${u.id}" class="edit-update-btn text-xs font-semibold text-slate-400 hover:text-sky-600">EDIT</button>
                                        <button data-update-id="${u.id}" class="delete-update-btn text-xs font-semibold text-slate-400 hover:text-red-500">DELETE</button>
                                    </div>
                                </div>`).join('') : `<p class="text-center text-slate-500 py-8">No updates logged for ${person.name}.</p>`}
                        </div>
                        <div id="tasks-content" class="tab-pane hidden">
                             ${personTasks.length > 0 ? personTasks.map(t => `
                                <div class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <button data-task-id="${t.id}" class="toggle-task-btn h-6 w-6 flex-shrink-0 flex items-center justify-center border-2 ${t.completed ? 'border-green-500 bg-green-500' : 'border-slate-300'} rounded-full transition">
                                            ${t.completed ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                                        </button>
                                        <div>
                                            <p class="font-medium ${t.completed ? 'text-slate-400 line-through' : 'text-slate-800'}">${t.description}</p>
                                            <p class="text-sm text-slate-500">Due: ${utils.formatDate(t.dueDate)}</p>
                                        </div>
                                    </div>
                                    <button data-task-id="${t.id}" class="delete-task-btn text-slate-400 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                                </div>`).join('') : `<p class="text-center text-slate-500 py-8">No tasks for ${person.name}.</p>`}
                        </div>
                        <div id="milestones-content" class="tab-pane hidden">
                            ${personMilestones.length > 0 ? personMilestones.map(m => `
                                <div class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="bg-yellow-100 text-yellow-600 h-10 w-10 flex items-center justify-center rounded-full"><i class="${utils.getIconForMilestoneType(m.type)}"></i></div>
                                        <div>
                                            <p class="font-semibold text-slate-700">${m.type}</p>
                                            <p class="text-sm text-slate-500">${utils.formatDate(m.date)}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button data-milestone-id="${m.id}" class="edit-milestone-btn text-slate-400 hover:text-sky-600 transition"><i class="fas fa-pencil-alt"></i></button>
                                        <button data-milestone-id="${m.id}" class="delete-milestone-btn text-slate-400 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>`).join('') : `<p class="text-center text-slate-500 py-8">No milestones for ${person.name}.</p>`}
                        </div>
                        <div id="prayer-content" class="tab-pane hidden">
                            <div class="text-right mb-4">
                                <button data-person-id="${person.id}" class="add-prayer-request-btn bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg">Add Prayer Request</button>
                            </div>
                            <div class="space-y-3">
                                ${personPrayerReqs.length > 0 ? personPrayerReqs.map(pr => `
                                    <div class="bg-white p-4 rounded-xl shadow-sm">
                                        <div class="flex justify-between items-start">
                                            <p class="text-slate-700 flex-1 mr-4 whitespace-pre-wrap">${pr.request}</p>
                                            <div class="flex items-center gap-3">
                                                <button data-pr-id="${pr.id}" class="toggle-prayer-status-btn font-semibold text-sm py-1 px-3 rounded-full ${pr.status === 'Answered' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">${pr.status}</button>
                                            </div>
                                        </div>
                                        <p class="text-xs text-slate-400 mt-2">Requested on ${utils.formatDate(pr.createdAt)}</p>
                                         <div class="flex justify-end gap-2 mt-2 pt-2 border-t border-slate-100">
                                            <button data-pr-id="${pr.id}" class="edit-prayer-request-btn text-xs font-semibold text-slate-400 hover:text-sky-600">EDIT</button>
                                            <button data-pr-id="${pr.id}" class="delete-prayer-request-btn text-xs font-semibold text-slate-400 hover:text-red-500">DELETE</button>
                                        </div>
                                    </div>`).join('') : `<p class="text-center text-slate-500 py-8">No prayer requests logged for ${person.name}.</p>`}
                            </div>
                        </div>
                         <div id="calling-content" class="tab-pane hidden">
                            <div class="bg-white rounded-2xl shadow-sm p-4">
                                <form id="calling-form" data-person-id="${person.id}">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-lg font-semibold text-slate-700 mb-2">Spiritual Gifts</label>
                                            <div class="max-h-48 overflow-y-auto space-y-1 p-2 border rounded-lg">
                                                ${state.spiritualGifts.map(g => `<label class="flex items-center gap-2 p-1"><input type="checkbox" name="gifts" value="${g}" ${(person.gifts || []).includes(g) ? 'checked' : ''}>${g}</label>`).join('')}
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-lg font-semibold text-slate-700 mb-2">Church Roles</label>
                                            <div class="max-h-48 overflow-y-auto space-y-1 p-2 border rounded-lg">
                                                ${state.churchRoles.map(r => `<label class="flex items-center gap-2 p-1"><input type="checkbox" name="roles" value="${r}" ${(person.roles || []).includes(r) ? 'checked' : ''}>${r}</label>`).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-6 flex justify-end">
                                        <button type="submit" class="bg-sky-600 text-white font-semibold py-2 px-5 rounded-lg">Save Calling</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>`;
            },
            overdueList() {
                 if (!state.dataLoaded) return;
                 ui.appLoading.classList.add('hidden');
                 
                 const peopleToContact = utils.getPeopleToContact();

                 ui.mainContent.innerHTML = `<div class="animate-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-slate-800">Overdue List</h2>
                        <span class="font-bold text-xl text-red-500">${peopleToContact.length}</span>
                    </div>
                     <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <ul id="overdue-list-container" class="divide-y divide-slate-200">
                            ${peopleToContact.length > 0 ? peopleToContact.map(p => {
                                const lastContact = utils.getLastContact(p.id);
                                const hasWhatsApp = p.phone && p.phone.length > 5;
                                return `<li class="p-3">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-4 person-item cursor-pointer" data-person-id="${p.id}">
                                            ${utils.getAvatar(p)}
                                            <div>
                                                <p class="font-semibold text-slate-800">${p.name}</p>
                                                <p class="text-sm text-slate-500">${lastContact ? `Last contact: ${utils.formatRelativeTime(lastContact.createdAt)}` : 'No contact logged'}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                             <button data-person-id="${p.id}" class="get-conversation-starters text-sky-600 h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-full hover:bg-sky-100" title="Get AI Conversation Starters">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                            ${hasWhatsApp ? `<a href="https://wa.me/${utils.formatPhoneNumberForWhatsApp(p.phone)}" target="_blank" class="bg-green-100 text-green-700 h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-full"><i class="fab fa-whatsapp text-xl"></i></a>` : ''}
                                            <button data-person-id="${p.id}" class="log-contact-btn bg-sky-100 text-sky-700 h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-full"><i class="fas fa-edit"></i></button>
                                        </div>
                                    </div>
                                    <div id="convo-starter-${p.id}" class="hidden mt-3 p-3 bg-sky-50 rounded-lg text-sm text-sky-800"></div>
                                </li>`
                            }).join('') : `<li class="p-8 text-center text-slate-500"><i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i><p>Everyone is up to date!</p></li>`}
                        </ul>
                    </div>
                 </div>`;
            },
            hospitality() {
                if (!state.dataLoaded) return;
                ui.appLoading.classList.add('hidden');
                
                const now = new Date();
                const upcomingEvents = state.hospitality
                    .filter(h => new Date(h.date) >= now)
                    .sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime());
                const pastEvents = state.hospitality
                    .filter(h => new Date(h.date) < now)
                    .sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());

                const renderEvent = (h) => {
                    const title = h.type === 'host' ? (h.attendee_families || []).join(', ') : `Guests at ${h.host_family}`;
                    const icon = h.type === 'host' ? 'fa-house-user' : 'fa-handshake';
                    const iconBg = h.type === 'host' ? 'bg-sky-100 text-sky-700' : 'bg-purple-100 text-purple-700';

                    return `<div class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center gap-3">
                                <div class="${iconBg} h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-full"><i class="fas ${icon}"></i></div>
                                <div>
                                    <p class="font-semibold text-slate-800">${title || '(No attendees)'}</p>
                                    <p class="text-sm text-slate-500">${utils.formatDate(h.date, {weekday: 'long'})}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-event-id="${h.id}" class="edit-hospitality-btn text-slate-400 hover:text-sky-600 px-2"><i class="fas fa-pencil-alt"></i></button>
                                <button data-event-id="${h.id}" class="delete-hospitality-btn text-slate-400 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        ${!h.journal ? `
                            <div class="text-right mt-3 pt-3 border-t border-slate-100">
                                <button data-event-id="${h.id}" class="log-hospitality-journal-btn bg-amber-100 text-amber-700 font-semibold py-1.5 px-3 rounded-lg text-sm">Log Journal</pre>
                            </div>
                        ` : `
                            <p class="text-sm text-slate-600 mt-3 pt-3 border-t border-slate-100 whitespace-pre-wrap">${h.journal}</p>
                        `}
                    </div>`;
                };

                ui.mainContent.innerHTML = `<div class="animate-enter">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Hospitality</h2>
                        <button id="add-hospitality-btn" class="bg-amber-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                            <i class="fas fa-plus"></i> Add Event
                        </button>
                    </div>
                     <div class="flex items-center gap-2 mb-4 p-1 bg-slate-200 rounded-full">
                        <button class="tab-btn flex-1 ${state.hospitalitySubView === 'upcoming' ? 'active' : ''}" data-subview="upcoming">Upcoming</button>
                        <button class="tab-btn flex-1 ${state.hospitalitySubView === 'past' ? 'active' : ''}" data-subview="past">Past</button>
                    </div>
                    <div class="space-y-3">
                        ${state.hospitalitySubView === 'upcoming' ? 
                            (upcomingEvents.length > 0 ? upcomingEvents.map(renderEvent).join('') : '<p class="text-center text-slate-500 py-8">No upcoming hospitality events.</p>') :
                            (pastEvents.length > 0 ? pastEvents.map(renderEvent).join('') : '<p class="text-center text-slate-500 py-8">No past hospitality events.</p>')
                        }
                    </div>
                </div>`;
            },
            resources() {
                 if (!state.dataLoaded) return;
                 ui.appLoading.classList.add('hidden');
                 ui.mainContent.innerHTML = `<div class="animate-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-slate-800">Resources</h2>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="text-xl font-bold mb-4">Sermon Illustration Creator</h3>
                        <p class="text-slate-500 mb-2">Hello pastor. As your 'Sermon Illustration Creator', I'm here to find riveting, effective, and powerful illustrations for your message.</p>
                        <p class="text-slate-500 mb-4">What is your sermon point?</p>
                        
                        <div class="flex gap-2">
                            <input type="text" id="sermon-topic-input" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500" placeholder="e.g., The Perseverance of the Saints">
                            <button id="get-illustration-btn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg"><i class="fas fa-arrow-right"></i></button>
                        </div>

                        <div id="illustration-output" class="mt-6 space-y-4">
                            <div id="illustration-loading" class="text-center text-slate-500 hidden">
                                <i class="fas fa-spinner animate-spin text-2xl"></i>
                                <p class="mt-2">Generating illustrations...</p>
                            </div>
                            <div id="illustration-error" class="text-center text-red-500 hidden"></div>
                            <div id="illustration-content"></div>
                        </div>
                    </div>
                 </div>`;
            },
            settings() {
                const households = [{name: "None", members:[]}].concat(utils.getHouseholds());
                const myHousehold = state.settings.myHousehold || "None";
                
                modalService.open(`<div class="p-6">
                    <h3 class="text-xl font-bold mb-4">Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="my-household-select" class="block text-sm font-medium text-slate-600 mb-1">My Household</label>
                            <select id="my-household-select" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                ${households.map(h => `<option value="${h.name}" ${h.name === myHousehold ? 'selected' : ''}>${h.name}</option>`).join('')}
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Select your own family to exclude it from pastoral lists.</p>
                        </div>
                        
                        <button id="save-settings-btn" class="w-full bg-sky-600 text-white font-semibold py-2.5 rounded-lg">Save Settings</button>

                        <hr class="my-4">

                        <div>
                            <h4 class="text-lg font-semibold mb-2">Backup & Restore</h4>
                            <p class="text-sm text-slate-500 mb-3">Save your data to a file, or restore from a previous backup.</p>
                            <div class="grid grid-cols-2 gap-3">
                                <button id="modal-backup-btn" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                                    <i class="fas fa-download"></i> Backup Now
                                </button>
                                <button id="modal-restore-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                                    <i class="fas fa-upload"></i> Restore
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`);
            }
        };

        // --- GEMINI SERVICES ---
        const geminiService = {
            async getConversationStarters(personId) {
                const person = state.people.find(p => p.id === personId);
                if (!person) return;
                
                const outputEl = document.getElementById('conversation-starters-output') || document.getElementById(`convo-starter-${personId}`);
                if (!outputEl) return;
                outputEl.innerHTML = `<i class="fas fa-spinner animate-spin"></i> Getting suggestions...`;
                outputEl.classList.remove('hidden');

                const lastUpdate = utils.getLastContact(personId);
                const systemPrompt = "You are a pastoral assistant. Given a person's key info and last update, provide 3-4 brief, thoughtful, and natural conversation starters for a WhatsApp message or phone call. Be warm and encouraging.";
                let userPrompt = `Person: ${person.name}\n`;
                if (person.keyInfo) {
                    userPrompt += `Key Info: ${person.keyInfo}\n`;
                }
                if (lastUpdate) {
                    userPrompt += `Last Update (${utils.formatRelativeTime(lastUpdate.createdAt)} - ${lastUpdate.type}): ${lastUpdate.notes}\n`;
                } else {
                    userPrompt += `Last Update: No contact logged yet.\n`;
                }
                userPrompt += "Generate 3-4 conversation starters.";

                try {
                    const result = await utils.callGeminiApi(systemPrompt, userPrompt);
                    outputEl.innerHTML = result.replace(/(\d\.)/g, '<br>$1'); // Add line breaks
                } catch (error) {
                    outputEl.innerHTML = "Could not get suggestions. Please log contact manually.";
                }
            },
            async getTaskBreakdown(description) {
                const btn = document.getElementById('ai-task-breakdown-btn');
                const spinner = document.getElementById('ai-task-spinner');
                btn.classList.add('hidden');
                spinner.classList.remove('hidden');

                const systemPrompt = "You are a task management assistant. A user will provide a large task. Break it down into a simple, actionable checklist. Append this checklist to the original task description. The output should be the *original description* followed by the checklist.";
                const userPrompt = `Task: ${description}\n\nBreak this down into a checklist.`;

                try {
                    const result = await utils.callGeminiApi(systemPrompt, userPrompt);
                    document.getElementById('task-description').value = result;
                } catch (error) {
                    utils.showToast("Could not break down task.");
                } finally {
                    btn.classList.remove('hidden');
                    spinner.classList.add('hidden');
                }
            },
            async getSermonIllustration(topic) {
                const loadingEl = document.getElementById('illustration-loading');
                const errorEl = document.getElementById('illustration-error');
                const contentEl = document.getElementById('illustration-content');

                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                contentEl.innerHTML = '';

                const systemPrompt = `
You are an expert 'Sermon Illustration Creator' for a conservative, Bible-believing Evangelical Christian pastor (who respects MacArthur, Piper, Washer).
Your task is to provide a detailed and robust response for a single sermon point.
Your response MUST be structured in JSON format. Do not write any text outside the main JSON object.

The JSON object must have three top-level keys: "illustrations", "statistics", and "powerQuotes", "parallelScriptures".

1.  **"illustrations"**: An array of 5 objects. Each object must have "type" (string) and "text" (string). The 5 types MUST be:
    - "Historically Accurate"
    - "Humorous & Historically Accurate"
    - "Old Testament Story"
    - "Modern Story"
    - "Bonus/Wildcard (Science, Nature, or Literature)"
    For each, include a (Source: ...) at the end of the text.

2.  **"statistics"**: An array of 1 object. The object must have "statistic" (string) and "source" (string).

3.  **"powerQuotes"**: An array of 5 objects. Each object must have "quote" (string) and "author" (string).

4.  **"parallelScriptures"**: An array of 3 objects. Each object must have "reference" (string) and "text" (string). All scripture MUST be from the King James Version (KJV).

Do not use markdown or tables. Only output the raw JSON object.
`;
                const userPrompt = `Sermon Point: ${topic}`;

                try {
                    const rawResult = await utils.callGeminiApi(systemPrompt, userPrompt);
                    
                    // Clean the result to ensure it's valid JSON
                    const jsonString = rawResult.trim().replace(/^```json\s*/, '').replace(/```$/, '');
                    const result = JSON.parse(jsonString);

                    let html = '';

                    // Illustrations
                    if (result.illustrations && result.illustrations.length > 0) {
                        html += '<h4 class="text-lg font-semibold mb-2">Illustrations</h4>';
                        result.illustrations.forEach(item => {
                            html += `<div class="gemini-output-card">
                                <button class="copy-btn" data-text="${encodeURIComponent(item.text)}"><i class="fas fa-copy"></i></button>
                                <strong class="text-sky-700">${item.type}</strong>
                                <p class="mt-2 text-sm">${item.text.replace(/\n/g, '<br>')}</p>
                            </div>`;
                        });
                    }

                    // Supporting Material
                    html += '<h4 class="text-lg font-semibold mt-6 mb-2">Supporting Material</h4>';
                    
                    // Statistics
                    if (result.statistics && result.statistics.length > 0) {
                        const item = result.statistics[0];
                        const text = `${item.statistic} (Source: ${item.source})`;
                        html += `<div class="gemini-output-card">
                            <button class="copy-btn" data-text="${encodeURIComponent(text)}"><i class="fas fa-copy"></i></button>
                            <strong class="text-sky-700">Statistic</strong>
                            <p class="mt-2 text-sm">${text}</p>
                        </div>`;
                    }

                    // Power Quotes
                    if (result.powerQuotes && result.powerQuotes.length > 0) {
                        const allQuotes = result.powerQuotes.map(item => `"${item.quote}"  ${item.author}`).join('\n\n');
                        html += `<div class="gemini-output-card">
                            <button class="copy-btn" data-text="${encodeURIComponent(allQuotes)}"><i class="fas fa-copy"></i></button>
                            <strong class="text-sky-700">Power Quotes</strong>
                            <div class="mt-2 text-sm">${allQuotes.replace(/\n/g, '<br>')}</div>
                        </div>`;
                    }

                    // Parallel Scriptures
                    if (result.parallelScriptures && result.parallelScriptures.length > 0) {
                        const allScriptures = result.parallelScriptures.map(item => `${item.reference} (KJV):\n"${item.text}"`).join('\n\n');
                        html += `<div class="gemini-output-card">
                            <button class="copy-btn" data-text="${encodeURIComponent(allScriptures)}"><i class="fas fa-copy"></i></button>
                            <strong class="text-sky-700">Parallel Scriptures (KJV)</strong>
                            <div class="mt-2 text-sm">${allScriptures.replace(/\n/g, '<br>')}</div>
                        </div>`;
                    }

                    contentEl.innerHTML = html;

                } catch (error) {
                    console.error("Sermon Illustration Error:", error);
                    errorEl.textContent = `Error generating response. ${error.message}. Please try again.`;
                    errorEl.classList.remove('hidden');
                } finally {
                    loadingEl.classList.add('hidden');
                }
            }
        };

        // --- MODALS (Content Generators) ---
        const modals = {
            logContact(personId) {
                const person = state.people.find(p => p.id === personId);
                modalService.open(`<form id="log-contact-form" class="p-6" data-person-id="${personId}">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Log Contact for ${person.name}</h3>
                        <button type="button" class="close-modal-btn text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="update-type" class="block text-sm font-medium text-slate-600 mb-1">Type</label>
                            <select id="update-type" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                <option value="WhatsApp Chat">WhatsApp Chat</option>
                                <option value="Phone Call">Phone Call</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Home Visit">Home Visit</option>
                                <option value="Hospital Visit">Hospital Visit</option>
                                <option value="Prayer">Prayer</option>
                                <option value="Counseling">Counseling</option>
                                <option value="General Note">General Note</option>
                            </select>
                        </div>
                        <div>
                            <label for="update-notes" class="block text-sm font-medium text-slate-600 mb-1">Notes from conversation</label>
                            <textarea id="update-notes" rows="5" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Enter details here..."></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="submit" class="w-full bg-sky-600 text-white font-semibold py-2.5 px-5 rounded-lg">Log Contact</button>
                    </div>
                </form>`);
            },
            addEditPerson(person) { 
                const isEditing = !!person; 
                modalService.open(`<form id="person-form" data-person-id="${person?.id || ''}" class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">${isEditing ? 'Edit Person' : 'Add New Person'}</h3>
                        <button type="button" class="close-modal-btn text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="person-name" class="block text-sm font-medium text-slate-600 mb-1">Full Name</label>
                            <input type="text" id="person-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg" value="${person?.name || ''}" required>
                        </div>
                        <div>
                            <label for="person-family" class="block text-sm font-medium text-slate-600 mb-1">Family / Household</label>
                            <input type="text" id="person-family" class="w-full px-3 py-2 border border-slate-300 rounded-lg" value="${person?.family || ''}" placeholder="e.g., The Smiths">
                        </div>
                        <div>
                            <label for="person-phone" class="block text-sm font-medium text-slate-600 mb-1">Phone Number</label>
                            <input type="tel" id="person-phone" class="w-full px-3 py-2 border border-slate-300 rounded-lg" value="${person?.phone || ''}">
                        </div>
                        <div>
                            <label for="person-email" class="block text-sm font-medium text-slate-600 mb-1">Email</label>
                            <input type="email" id="person-email" class="w-full px-3 py-2 border border-slate-300 rounded-lg" value="${person?.email || ''}">
                        </div>
                        <div>
                            <label for="person-keyinfo" class="block text-sm font-medium text-slate-600 mb-1">Pastoral Concerns / Key Info</label>
                            <textarea id="person-keyinfo" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="e.g., Job searching...">${person?.keyInfo || ''}</textarea>
                            ${!isEditing ? `<button type="button" id="ai-welcome-note-btn" class="mt-1 text-xs font-semibold text-sky-600 flex items-center gap-1"><i class="fas fa-magic"></i> AI Welcome Note</button>` : ''}
                        </div>
                        <div>
                            <label for="person-pulse" class="block text-sm font-medium text-slate-600 mb-1">Contact Pulse (days)</label>
                            <input type="number" id="person-pulse" class="w-full px-3 py-2 border border-slate-300 rounded-lg" value="${person?.pulse || DEFAULT_PULSE}" required>
                            <p class="text-xs text-slate-500 mt-1">Remind me if no contact is logged in this many days.</p>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="submit" class="w-full bg-sky-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-sky-700 transition">Save</button>
                    </div>
                </form>`); 
            },
            addEditUpdate(personId = null, update = null) {
                const isEditing = !!update;
                const peopleOptions = state.people
                    .filter(p => p.family !== state.settings.myHousehold)
                    .sort((a,b) => a.name.localeCompare(b.name))
                    .map(p => `<option value="${p.id}" ${personId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                const personSelect = personId === null ? `<div><label class="block text-sm font-medium text-slate-600 mb-1">Person</label><select id="update-person-id" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>${peopleOptions}</select></div>` : '';
                const types = ['Meeting', 'Phone Call', 'WhatsApp Chat', 'Hospital Visit', 'Home Visit', 'Prayer', 'Counseling', 'General Note'];
                modalService.open(`<form id="update-form" class="p-6" data-person-id="${personId || ''}" data-update-id="${update?.id || ''}">
                    <h3 class="text-xl font-bold mb-4">${isEditing ? 'Edit' : 'Log'} Update</h3>
                    <div class="space-y-4">
                        ${personSelect}
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Type</label>
                            <select id="update-type" class="w-full px-3 py-2 border border-slate-300 rounded-lg">${types.map(t => `<option value="${t}" ${isEditing && t === update.type ? 'selected' : ''}>${t}</option>`).join('')}</select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Notes</label>
                            <textarea id="update-notes" rows="4" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>${update?.notes || ''}</textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end"><button type="submit" class="w-full bg-sky-600 text-white font-semibold py-2.5 px-5 rounded-lg">Save Update</button></div>
                </form>`);
            },
            addEditTask(personId = null) {
                const peopleOptions = state.people
                    .filter(p => p.family !== state.settings.myHousehold)
                    .sort((a,b) => a.name.localeCompare(b.name))
                    .map(p => `<option value="${p.id}" ${personId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                const personSelect = personId === null ? `<div><label class="block text-sm font-medium text-slate-600 mb-1">For Person</label><select id="task-person-id" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>${peopleOptions}</select></div>` : '';
                modalService.open(`<form id="task-form" class="p-6" data-person-id="${personId || ''}">
                    <h3 class="text-xl font-bold mb-4">Create a Task</h3>
                    <div class="space-y-4">
                        ${personSelect}
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Description</label>
                            <div class="flex gap-2">
                                <input type="text" id="task-description" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>
                                <button type="button" id="ai-task-breakdown-btn" class="bg-sky-100 text-sky-700 font-semibold px-3 rounded-lg" title="AI Task Breakdown"></button>
                                <button type="button" id="ai-task-spinner" class="bg-sky-100 text-sky-700 font-semibold px-3 rounded-lg hidden" disabled><i class="fas fa-spinner animate-spin"></i></button>
                            </div>
                            <textarea id="task-description-breakdown" rows="5" class="w-full px-3 py-2 border border-slate-300 rounded-lg mt-2 hidden" placeholder="Checklist..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Due Date</label>
                            <input type="date" id="task-due-date" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end"><button type="submit" class="w-full bg-sky-600 text-white font-semibold py-2.5 px-5 rounded-lg">Add Task</button></div>
                </form>`);
            },
            addEditMilestone(personId, milestone) { 
                const isEditing = !!milestone; 
                const types = ['Birthday', 'Anniversary', 'Baptism', 'Joined Church', 'Loss of Loved One']; 
                modalService.open(`<form id="milestone-form" class="p-6" data-person-id="${personId}" data-milestone-id="${milestone?.id || ''}">
                    <h3 class="text-xl font-bold mb-4">${isEditing ? 'Edit' : 'Record'} Milestone</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Type</label>
                            <select id="milestone-type" class="w-full px-3 py-2 border border-slate-300 rounded-lg">${types.map(t => `<option value="${t}" ${isEditing && t === milestone.type ? 'selected': ''}>${t}</option>`).join('')}</select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Date</label>
                            <input type="date" id="milestone-date" class="w-full px-3 py-2 border border-slate-300 rounded-lg" value="${milestone ? new Date(milestone.date).toISOString().split('T')[0] : ''}" required>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end"><button type="submit" class="w-full bg-sky-600 text-white font-semibold py-2.5 px-5 rounded-lg">Save</button></div>
                </form>`); 
            },
            addEditHospitalityEvent(event = null, prefilledFamilies = []) {
                const isEditing = !!event; 
                const households = utils.getHouseholds(); 
                const date = event ? new Date(event.date) : new Date(); 
                const dateString = date.toISOString().split('T')[0];
                const type = event ? event.type : 'host';
                
                modalService.open(`<form id="hospitality-form" class="p-6" data-event-id="${event?.id || ''}">
                    <h3 class="text-xl font-bold mb-4">${isEditing ? 'Edit' : 'Plan'} Hospitality Event</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Date</label>
                            <input type="date" id="hospitality-date" class="w-full px-3 py-2 border border-slate-300 rounded-lg" value="${dateString}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Type of Event</label>
                            <select id="hospitality-type" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                <option value="host" ${type === 'host' ? 'selected' : ''}>We Hosted</option>
                                <option value="guest" ${type === 'guest' ? 'selected' : ''}>We Were Guests</option>
                            </select>
                        </div>
                        
                        <div id="host-fields" class="${type === 'host' ? '' : 'hidden'}">
                            <label class="block text-sm font-medium text-slate-600 mb-1">Attendees (Households)</label>
                            <div class="max-h-48 overflow-y-auto space-y-2 p-3 border rounded-lg">
                                ${households.map(h => `<label class="flex items-center gap-3 p-1 rounded-md hover:bg-slate-100">
                                    <input type="checkbox" name="attendees" value="${h.name}" class="h-4 w-4 rounded" ${ (isEditing && (event.attendee_families || []).includes(h.name)) || (!isEditing && prefilledFamilies.includes(h.name)) ? 'checked' : ''}>
                                    <span>${h.name}</span>
                                </label>`).join('')}
                            </div>
                        </div>

                        <div id="guest-fields" class="${type === 'guest' ? '' : 'hidden'}">
                            <label for="hospitality-host" class="block text-sm font-medium text-slate-600 mb-1">Host Family</label>
                            <select id="hospitality-host" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                ${households.map(h => `<option value="${h.name}" ${event?.host_family === h.name ? 'selected' : ''}>${h.name}</option>`).join('')}
                            </select>
                        </div>

                    </div>
                    <div class="mt-6 flex justify-end"><button type="submit" class="w-full bg-amber-500 text-white font-semibold py-2.5 px-5 rounded-lg">Save Event</button></div>
                </form>`, 'lg');
            },
            logHospitalityJournal(eventId) {
                const event = state.hospitality.find(e => e.id === eventId);
                if (!event) return;
                const title = event.type === 'host' ? (event.attendee_families || []).join(', ') : `at ${event.host_family}'s`;
                modalService.open(`<form id="hospitality-journal-form" class="p-6" data-event-id="${eventId}">
                    <h3 class="text-xl font-bold mb-4">Journal for ${title}</h3>
                    <textarea id="hospitality-journal" rows="8" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Log details about the visit...">${event.journal || ''}</textarea>
                    <div class="mt-6 flex justify-end"><button type="submit" class="w-full bg-amber-500 text-white font-semibold py-2.5 px-5 rounded-lg">Save Journal</button></div>
                </form>`);
            },
            addEditPrayerRequest(personId, request) {
                const isEditing = !!request;
                modalService.open(`<form id="prayer-request-form" class="p-6" data-person-id="${personId}" data-pr-id="${request?.id || ''}">
                    <h3 class="text-xl font-bold mb-4">${isEditing ? 'Edit' : 'Add'} Prayer Request</h3>
                    <textarea id="prayer-request-text" class="w-full px-3 py-2 border border-slate-300 rounded-lg" rows="5" required>${request?.request || ''}</textarea>
                    <div class="mt-6 flex justify-end"><button type="submit" class="w-full bg-sky-600 text-white font-semibold py-2.5 px-5 rounded-lg">Save Request</button></div>
                </form>`);
            },
            confirm(title, message, onConfirm) { 
                modalService.open(`<div class="p-6 text-center">
                    <div class="text-4xl text-amber-500 mb-4"><i class="fas fa-exclamation-triangle"></i></div>
                    <h3 class="text-xl font-bold mb-2">${title}</h3>
                    <p class="text-slate-500 mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button type="button" class="cancel-confirm-btn bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
                        <button type="button" class="confirm-btn bg-red-600 text-white font-semibold py-2 px-6 rounded-lg">Delete</button>
                    </div>
                </div>`); 
                const confirmBtn = ui.modalContent.querySelector('.confirm-btn');
                const cancelBtn = ui.modalContent.querySelector('.cancel-confirm-btn');
                confirmBtn.onclick = () => { onConfirm(); modalService.close(); }; 
                cancelBtn.onclick = () => modalService.close(); 
            },
            confirmImport(contacts) {
                modalService.open(`<div class="p-6">
                    <h3 class="text-xl font-bold mb-4">Confirm Import</h3>
                    <p class="text-slate-500 mb-4">You're about to import the following ${contacts.length} contacts. Does this look right?</p>
                    <div class="max-h-60 overflow-y-auto space-y-3 p-3 border rounded-lg mb-6">
                        ${contacts.map(c => `
                            <div class="flex items-center gap-3">
                                ${c.photoURL ? `<img src="${c.photoURL}" class="avatar w-10 h-10">` : `<div class="avatar bg-slate-200 text-slate-500 w-10 h-10">${utils.generateInitials(c.name)}</div>`}
                                <div>
                                    <p class="font-semibold">${c.name}</p>
                                    <p class="text-sm text-slate-500">${c.phone || 'No phone'}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" class="cancel-confirm-btn bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
                        <button type="button" id="confirm-import-execute-btn" class="bg-sky-600 text-white font-semibold py-2 px-6 rounded-lg">Import</button>
                    </div>
                </div>`, 'lg');

                document.getElementById('confirm-import-execute-btn').onclick = async () => {
                    appController.importContactsExecute(contacts);
                    modalService.close();
                    utils.showToast(`${contacts.length} contacts imported!`);
                };
                ui.modalContent.querySelector('.cancel-confirm-btn').onclick = () => modalService.close();
            }
        };

        // --- APP CONTROLLER ---
        const appController = {
            init() {
                db.init(); // Load data from localStorage
                this.setupEventListeners();
                this.navigateTo('dashboard');
            },
            setupEventListeners() {
                // Bottom Nav
                ui.navButtons.forEach(btn => {
                    btn.addEventListener('click', () => this.navigateTo(btn.dataset.view));
                });

                // Header Buttons
                ui.backupBtn.addEventListener('click', () => db.backup());
                ui.restoreBtn.addEventListener('click', () => ui.restoreInput.click());
                ui.restoreInput.addEventListener('change', e => {
                    if (e.target.files && e.target.files[0]) {
                        db.restore(e.target.files[0]);
                    }
                });
                ui.settingsBtn.addEventListener('click', () => render.settings());

                // Main Content Event Delegation
                ui.mainContent.addEventListener('click', e => {
                    const eventMap = {
                         // --- People List ---
                         '.person-item': el => this.navigateTo('person-detail', el.closest('[data-person-id]').dataset.personId),
                         '#add-person-btn': () => modals.addEditPerson(),
                         '#import-contacts-btn': () => this.importContactsStart(),
                         '.tab-btn': el => {
                            const subview = el.dataset.subview;
                            if (state.currentView === 'people') state.peopleSubView = subview;
                            if (state.currentView === 'overdue') state.overdueSubView = subview;
                            if (state.currentView === 'hospitality') state.hospitalitySubView = subview;
                            this.refreshCurrentView();
                         },

                         // --- Dashboard ---
                         '.log-contact-btn': el => modals.logContact(el.dataset.personId),
                         '.view-person-btn': el => this.navigateTo('person-detail', el.dataset.personId),
                         '#quick-add-person': () => modals.addEditPerson(),
                         '#quick-add-task': () => modals.addEditTask(),
                         '#quick-add-update': () => modals.addEditUpdate(),
                         '#get-conversation-starters': el => geminiService.getConversationStarters(el.dataset.personId),
                         '.log-hospitality-btn': el => modals.addEditHospitalityEvent(null, [el.dataset.families]),

                         // --- Overdue List ---
                         '.get-conversation-starters': el => geminiService.getConversationStarters(el.dataset.personId),

                         // --- Person Detail ---
                         '#back-to-people': () => this.navigateTo('people'),
                         '#save-person-details-btn': () => this.savePersonDetails(),
                         '#delete-person-btn': el => {
                            const personId = el.dataset.personId;
                            const person = state.people.find(p => p.id === personId);
                            if (person) {
                                modals.confirm(`Delete ${person.name}?`, 'This will permanently delete their profile and all associated data.', () => this.deletePerson(personId));
                            }
                         },
                         '.add-update-btn': el => modals.addEditUpdate(el.dataset.personId),
                         '.edit-update-btn': el => modals.addEditUpdate(state.selectedPerson.id, state.updates.find(u => u.id === el.dataset.updateId)),
                         '.delete-update-btn': el => modals.confirm('Delete Update?', 'This action cannot be undone.', () => this.deleteUpdate(el.dataset.updateId)),
                         
                         '.add-task-btn': el => modals.addEditTask(el.dataset.personId),
                         '.toggle-task-btn': el => this.toggleTask(el.dataset.taskId),
                         '.delete-task-btn': el => modals.confirm('Delete Task?', 'This action cannot be undone.', () => this.deleteTask(el.dataset.taskId)),
                         
                         '.add-milestone-btn': el => modals.addEditMilestone(el.dataset.personId),
                         '.edit-milestone-btn': el => modals.addEditMilestone(state.selectedPerson.id, state.milestones.find(m => m.id === el.dataset.milestoneId)),
                         '.delete-milestone-btn': el => modals.confirm('Delete Milestone?', 'This action cannot be undone.', () => this.deleteMilestone(el.dataset.milestoneId)),

                         '.add-prayer-request-btn': el => modals.addEditPrayerRequest(el.dataset.personId),
                         '.edit-prayer-request-btn': el => modals.addEditPrayerRequest(state.selectedPerson.id, state.prayerRequests.find(pr => pr.id === el.dataset.prId)),
                         '.toggle-prayer-status-btn': el => this.togglePrayerStatus(el.dataset.prId),
                         '.delete-prayer-request-btn': el => modals.confirm('Delete Request?', 'This cannot be undone.', () => this.deletePrayerRequest(el.dataset.prId)),

                         '.person-tab-btn': el => this.switchPersonTab(el.dataset.tab),

                         // --- Hospitality ---
                         '#add-hospitality-btn': () => modals.addEditHospitalityEvent(),
                         '.edit-hospitality-btn': el => modals.addEditHospitalityEvent(state.hospitality.find(h => h.id === el.dataset.eventId)),
                         '.delete-hospitality-btn': el => modals.confirm('Delete Event?', 'This will be removed.', () => this.deleteHospitalityEvent(el.dataset.eventId)),
                         '.log-hospitality-journal-btn': el => modals.logHospitalityJournal(el.dataset.eventId),

                         // --- Resources ---
                         '#get-illustration-btn': () => {
                            const topic = document.getElementById('sermon-topic-input').value;
                            if (topic) geminiService.getSermonIllustration(topic);
                         },
                         '.copy-btn': el => {
                            const text = decodeURIComponent(el.dataset.text);
                            if (navigator.clipboard) {
                                navigator.clipboard.writeText(text).then(() => {
                                    utils.showToast('Copied to clipboard!');
                                }).catch(err => {
                                    utils.fallbackCopyText(text);
                                });
                            } else {
                                utils.fallbackCopyText(text);
                            }
                         }
                    };

                    for (const selector in eventMap) {
                        const el = e.target.closest(selector);
                        if (el) {
                            eventMap[selector](el);
                            return; // Stop after first match
                        }
                    }
                });
                
                // Modal Event Delegation
                ui.modalContainer.addEventListener('click', e => {
                    if (e.target === ui.modalContainer || e.target.closest('.close-modal-btn')) {
                        modalService.close();
                    }
                    
                    // Specific Modal Buttons
                    const eventMap = {
                        '#save-settings-btn': () => {
                            const myHousehold = document.getElementById('my-household-select').value;
                            state.settings.myHousehold = myHousehold === "None" ? null : myHousehold;
                            db.save();
                            utils.showToast('Settings saved!');
                            modalService.close();
                            this.refreshCurrentView(); // Refresh to apply filters
                        },
                        '#modal-backup-btn': () => { db.backup(); modalService.close(); },
                        '#modal-restore-btn': () => { ui.restoreInput.click(); modalService.close(); },
                        '#ai-task-breakdown-btn': () => {
                            const desc = document.getElementById('task-description').value;
                            if (desc) geminiService.getTaskBreakdown(desc);
                        },
                        '#ai-welcome-note-btn': () => {
                            const keyInfoEl = document.getElementById('person-keyinfo');
                            keyInfoEl.value = "New person, imported from contacts. Get to know their testimony, family situation, and how the church can pray for them.";
                        },
                        '#hospitality-type': el => {
                            const isHost = el.value === 'host';
                            document.getElementById('host-fields').classList.toggle('hidden', !isHost);
                            document.getElementById('guest-fields').classList.toggle('hidden', isHost);
                        }
                    };

                    for (const selector in eventMap) {
                        const el = e.target.closest(selector);
                        if (el) {
                            eventMap[selector](el);
                            return; // Stop after first match
                        }
                    }
                });

                // Modal Form Submissions
                ui.modalContent.addEventListener('submit', async e => {
                    e.preventDefault(); 
                    const form = e.target;
                    
                    if (form.id === 'person-form') {
                        const personId = form.dataset.personId || crypto.randomUUID();
                        const data = {
                            id: personId,
                            name: form.querySelector('#person-name').value,
                            family: form.querySelector('#person-family').value,
                            phone: form.querySelector('#person-phone').value,
                            email: form.querySelector('#person-email').value,
                            keyInfo: form.querySelector('#person-keyinfo').value,
                            pulse: parseInt(form.querySelector('#person-pulse').value, 10) || DEFAULT_PULSE,
                        };
                        
                        const existing = state.people.find(p => p.id === personId);
                        if (existing) {
                            Object.assign(existing, data);
                            utils.showToast('Person updated!');
                        } else {
                            data.createdAt = new Date().toISOString();
                            state.people.push(data);
                            utils.showToast('Person added!');
                        }
                    }
                    
                    if (form.id === 'log-contact-form' || form.id === 'update-form') {
                        const updateId = form.dataset.updateId || crypto.randomUUID();
                        const personId = form.dataset.personId || form.querySelector('#update-person-id')?.value;
                        if (!personId) { utils.showToast('Please select a person.'); return; }
                        
                        const data = {
                            id: updateId,
                            type: form.querySelector('#update-type').value,
                            notes: form.querySelector('#update-notes').value,
                            personId: personId
                        };

                        const existing = state.updates.find(u => u.id === updateId);
                        if (existing) {
                            Object.assign(existing, data);
                            utils.showToast('Update saved!');
                        } else {
                            data.createdAt = new Date().toISOString();
                            state.updates.push(data);
                            utils.showToast('Update logged!');
                        }
                    }
                    
                    if (form.id === 'task-form') {
                        const personId = form.dataset.personId || form.querySelector('#task-person-id')?.value;
                        if (!personId) { utils.showToast('Please select a person.'); return; }
                        const description = form.querySelector('#task-description').value;
                        const dueDate = form.querySelector('#task-due-date').value;
                        
                        state.tasks.push({
                            id: crypto.randomUUID(),
                            personId,
                            description,
                            dueDate: new Date(dueDate + 'T00:00:00').toISOString(),
                            completed: false,
                            createdAt: new Date().toISOString()
                        });
                        utils.showToast('Task added!'); 
                    }

                    if (form.id === 'milestone-form') {
                        const milestoneId = form.dataset.milestoneId || crypto.randomUUID();
                        const personId = form.dataset.personId;
                        const data = {
                            id: milestoneId,
                            type: form.querySelector('#milestone-type').value,
                            date: new Date(form.querySelector('#milestone-date').value + 'T00:00:00').toISOString(),
                            personId: personId
                        };
                        
                        const existing = state.milestones.find(m => m.id === milestoneId);
                        if (existing) {
                            Object.assign(existing, data);
                            utils.showToast('Milestone updated!');
                        } else {
                            data.createdAt = new Date().toISOString();
                            state.milestones.push(data);
                            utils.showToast('Milestone saved!');
                        }
                    }

                    if (form.id === 'hospitality-form') {
                        const eventId = form.dataset.eventId || crypto.randomUUID();
                        const type = form.querySelector('#hospitality-type').value;
                        let data = { id: eventId, type, date: new Date(form.querySelector('#hospitality-date').value + 'T00:00:00').toISOString() };

                        if (type === 'host') {
                            data.attendee_families = Array.from(form.querySelectorAll('input[name="attendees"]:checked')).map(el => el.value);
                        } else {
                            data.host_family = form.querySelector('#hospitality-host').value;
                        }

                        const existing = state.hospitality.find(e => e.id === eventId);
                        if (existing) {
                            Object.assign(existing, data);
                            utils.showToast('Event updated!');
                        } else {
                            data.createdAt = new Date().toISOString();
                            state.hospitality.push(data);
                            utils.showToast('Event saved!');
                            if(type === 'host' || type === 'guest') {
                                // Immediately open journal
                                modalService.close();
                                modals.logHospitalityJournal(eventId);
                                return; // Stop default close/save
                            }
                        }
                    }
                    
                    if (form.id === 'hospitality-journal-form') {
                        const eventId = form.dataset.eventId;
                        const journal = form.querySelector('#hospitality-journal').value;
                        const event = state.hospitality.find(e => e.id === eventId);
                        if (event) {
                            event.journal = journal;
                            utils.showToast('Journal saved!');
                            // --- THIS IS THE KEY INTEGRATION ---
                            // Auto-log an "Update" for all involved families
                            
                            let familiesToUpdate = [];
                            if (event.type === 'host') {
                                familiesToUpdate = event.attendee_families || [];
                            } else if (event.type === 'guest') {
                                familiesToUpdate = [event.host_family];
                            }

                            familiesToUpdate.forEach(family => {
                                const members = state.people.filter(p => p.family === family);
                                members.forEach(person => {
                                    state.updates.push({
                                        id: crypto.randomUUID(),
                                        personId: person.id,
                                        type: "Hospitality",
                                        notes: journal,
                                        createdAt: new Date(event.date).toISOString() // Use event date for contact pulse
                                    });
                                });
                            });
                        }
                    }

                    if (form.id === 'prayer-request-form') {
                        const prId = form.dataset.prId || crypto.randomUUID();
                        const personId = form.dataset.personId;
                        const data = {
                            id: prId,
                            request: form.querySelector('#prayer-request-text').value,
                            personId: personId
                        };

                        const existing = state.prayerRequests.find(pr => pr.id === prId);
                        if(existing) {
                            Object.assign(existing, data);
                            utils.showToast('Prayer request updated.');
                        } else {
                            data.status = 'Active';
                            data.createdAt = new Date().toISOString();
                            state.prayerRequests.push(data);
                            utils.showToast('Prayer request added.');
                        }
                    }
                    
                    if (form.id === 'calling-form') {
                        const personId = form.dataset.personId;
                        const person = state.people.find(p => p.id === personId);
                        if (person) {
                            person.gifts = Array.from(form.querySelectorAll('input[name="gifts"]:checked')).map(el => el.value);
                            person.roles = Array.from(form.querySelectorAll('input[name="roles"]:checked')).map(el => el.value);
                            utils.showToast('Calling info saved!');
                        }
                    }

                    db.save(); // Save changes to localStorage
                    modalService.close();
                    this.refreshCurrentView(); // Re-render
                });
            },
            async importContactsStart() {
                if (!('contacts' in navigator && 'ContactsManager' in window)) {
                    utils.showToast('Contact import is not supported on this device.');
                    return;
                }
                try {
                    const contacts = await navigator.contacts.select(['name', 'tel', 'icon', 'email'], { multiple: true });
                    if (contacts.length === 0) return;

                    const processedContacts = await Promise.all(contacts.map(async (contact) => {
                        let photoURL = null;
                        if (contact.icon && contact.icon.length > 0) {
                            try {
                                photoURL = await utils.blobToDataURL(contact.icon[0]);
                            } catch (e) {
                                console.error("Error reading contact icon:", e);
                            }
                        }
                        return {
                            name: contact.name[0] || 'No Name',
                            phone: contact.tel[0] || '',
                            email: contact.email[0] || '',
                            family: contact.name[0] ? contact.name[0].split(' ').pop() + ' Family' : 'New Contact',
                            photoURL: photoURL
                        };
                    }));
                    
                    modals.confirmImport(processedContacts);
                } catch (error) {
                    console.error('Error importing contacts:', error);
                    utils.showToast('Could not import contacts.');
                }
            },
            importContactsExecute(contacts) {
                contacts.forEach(contact => {
                    state.people.push({
                        id: crypto.randomUUID(),
                        ...contact,
                        pulse: DEFAULT_PULSE,
                        keyInfo: "Imported from device contacts.",
                        createdAt: new Date().toISOString()
                    });
                });
                db.save();
                this.refreshCurrentView();
            },
            savePersonDetails() {
                const person = state.selectedPerson;
                if (!person) return;

                person.name = document.getElementById('person-detail-name').value;
                person.family = document.getElementById('person-detail-family').value;
                person.keyInfo = document.getElementById('person-detail-keyinfo').value;
                person.phone = document.getElementById('person-detail-phone').value;
                person.email = document.getElementById('person-detail-email').value;
                person.pulse = parseInt(document.getElementById('person-detail-pulse').value, 10) || DEFAULT_PULSE;
                
                db.save();
                utils.showToast('Details updated!');
            },
            deletePerson(id) {
                state.people = state.people.filter(p => p.id !== id);
                state.updates = state.updates.filter(u => u.personId !== id);
                state.tasks = state.tasks.filter(t => t.personId !== id);
                state.milestones = state.milestones.filter(m => m.personId !== id);
                state.prayerRequests = state.prayerRequests.filter(pr => pr.personId !== id);
                // Also remove from hospitality
                
                db.save();
                utils.showToast('Person and all associated data deleted.');
                this.navigateTo('people');
            },
            deleteUpdate(id) { state.updates = state.updates.filter(u => u.id !== id); db.save(); this.refreshCurrentView(); utils.showToast('Update deleted.'); },
            toggleTask(id) { const task = state.tasks.find(t => t.id === id); if (task) task.completed = !task.completed; db.save(); this.refreshCurrentView(); },
            deleteTask(id) { state.tasks = state.tasks.filter(t => t.id !== id); db.save(); this.refreshCurrentView(); utils.showToast('Task deleted.'); },
            deleteMilestone(id) { state.milestones = state.milestones.filter(m => m.id !== id); db.save(); this.refreshCurrentView(); utils.showToast('Milestone deleted.'); },
            deleteHospitalityEvent(id) { state.hospitality = state.hospitality.filter(h => h.id !== id); db.save(); this.refreshCurrentView(); utils.showToast('Event deleted.'); },
            togglePrayerStatus(id) { const req = state.prayerRequests.find(pr => pr.id === id); if(req) { req.status = req.status === 'Active' ? 'Answered' : 'Active'; } db.save(); this.refreshCurrentView(); },
            deletePrayerRequest(id) { state.prayerRequests = state.prayerRequests.filter(pr => pr.id !== id); db.save(); this.refreshCurrentView(); utils.showToast('Request removed.'); },
            switchPersonTab(tab) {
                document.querySelectorAll('.person-tab-btn').forEach(btn => {
                    const isActive = btn.dataset.tab === tab;
                    btn.classList.toggle('active', isActive);
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.toggle('hidden', pane.id !== `${tab}-content`);
                });
            },
            refreshCurrentView() {
                if (!state.dataLoaded) {
                    ui.appLoading.classList.remove('hidden');
                    ui.mainContent.innerHTML = ''; 
                    return;
                }
                
                // Special case for person detail
                if (state.currentView === 'person-detail' && state.selectedPerson) {
                    render.personDetail(state.selectedPerson.id);
                    return;
                }

                switch (state.currentView) {
                    case 'dashboard': render.dashboard(); break;
                    case 'people': render.peopleList(); break;
                    case 'overdue': render.overdueList(); break;
                    case 'hospitality': render.hospitality(); break;
                    case 'resources': render.resources(); break;
                }
            },
            navigateTo(view, param = null) {
                // Handle navigation away from person detail
                if (state.currentView === 'person-detail' && view !== 'person-detail') {
                    state.selectedPerson = null;
                }
                
                state.currentView = view;
                if (param) {
                    state.selectedPerson = state.people.find(p => p.id === param);
                }

                ui.navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === view);
                });
                
                this.refreshCurrentView();
                ui.mainContent.scrollTop = 0; // Scroll to top on nav
            }
        };

        // --- App Initialization ---
        appController.init();
    </script>
</body>
</html>